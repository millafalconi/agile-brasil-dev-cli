#!/usr/bin/env bash
# vim: ft=sh

SUBCOMMAND_DESC="Cria, configura e inicia o transervicos em dev"
SUBCOMMAND_HELP=$(cat <<EOH
Usage ${MAIN_COMMAND} ${SUBCOMMAND} [init] [start] [build-start]

build Constroi ambiente de dev do transervicos
start Inicia app transervicos em dev
init  Constroi e configura ambiente de dev; e inicia a app
stop  Para a app em dev
clean_db Limpa os dados do banco de dados do transervicos

EOH
)

function build() {
  docker-compose up --no-start
}

function start() {
  docker-compose start
}

function init() {
  docker-compose up --build -d
  docker-compose run web bash -c "rake db:create && rake db:migrate"
}

function stop() {
  docker-compose stop $@
  #docker-compose rm -f -v $@
}

function clean_db() {
  stop db
  docker volume rm transervicos_db_data
}

function goto() {
  # db_container="transervicos_db_1"
  # host="db"
  # shift
  # cmd="open http://localhost:3000"

  # until docker exec -it ${db_container} psql -h ${host} -U "postgres" -p -c '\q'; do
  #   >&2 echo "Postgres is unavailable - sleeping"
  #   sleep 1
  # done
  # >&2 echo "Postgres is up - going to dev env"
  # exec $cmd
  open http://localhost:3000
}

is_help_mode "${@}" && return

case ${1} in
  build)
    build
    ;;
  start)
    start
    ;;
  init)
    init
    ;;
  stop)
    stop
    ;;
  clean_db)
    clean_db
    ;;
  goto)
    goto
    ;;
esac